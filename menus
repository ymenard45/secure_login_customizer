<?php
/*
Plugin Name: SecureLoginCustomizer
Description: Customizes the login screen and adds 2FA authentication for WordPress.
Version: 1.0
Author: YM
*/

// Exit if accessed directly.
if (!defined('ABSPATH')) {
    exit;
}

function __construct() {
        add_action('admin_menu', array($this, 'register_admin_menu'));
        add_action('admin_init', array($this, 'secure_login_customizer_register_settings'));
        add_action('admin_enqueue_scripts', array($this, 'secure_login_customizer_enqueue_scripts'));
        add_filter('plugin_action_links_' . plugin_basename(__FILE__), array($this, 'add_plugin_action_links'));
        add_filter('the_content', array($this, 'secure_login_customizer_add_shortcode_support'));
    }

function register_admin_menu() {
        add_submenu_page(
            'options-general.php',
            'Secure Login Customizer',
            'Secure Login Customizer',
            'manage_options',
            'secure_login_customizer',
            array($this, 'display_options_page')
        );
    }

function secure_login_customizer_add_admin_menu() {
        add_submenu_page(
            'options-general.php',
            'Secure Login Customizer',
            'Secure Login Customizer',
            'manage_options',
            'secure_login_customizer',
            array($this, 'display_options_page')
        );
    }


function secure_login_customizer_register_settings() {
        register_setting('secure_login_customizer_options', 'secure_login_customizer_options', array($this, 'secure_login_customizer_sanitize_options'));
    }


function add_plugin_action_links($links) {
        $settings_link = '<a href="options-general.php?page=secure_login_customizer">' . __('Settings') . '</a>';
        array_unshift($links, $settings_link);
        return $links;
    }

 function secure_login_customizer_add_shortcode_support($content) {
        $content = do_shortcode($content);
        return $content;
    }

 function secure_login_customizer_sanitize_options($options) {
        if (!is_array($options)) {
            $options = array();
        }

        foreach ($options as $name => &$value) {
            if ($name == 'lost_password_message') {
                $value = wp_kses_post($value);
            }
            elseif ($name == 'custom_css') {
                $value = wp_kses_post($value);
            }
            elseif ($name == 'blacklist') {
                $value = sanitize_text_field($value);
            }
            elseif ($name == 'whitelist') {
                $value = sanitize_text_field($value);
            }
        }

        return $options;
    }

function secure_login_customizer_init() {
  $customizer = new Secure_Login_Customizer();
  add_action('admin_menu', array('Secure_Login_Customizer', 'secure_login_customizer_add_admin_menu'));
}

add_action('init', 'secure_login_customizer_init');
add_action('admin_menu', array('Secure_Login_Customizer', 'secure_login_customizer_add_admin_menu'));

    /**
     * Display the options page.
     */
function display_options_page() {
        ?>
        <div class="wrap">
            <h1><?php esc_html_e('SecureLoginCustomizer', 'secure-login-customizer'); ?></h1>
            <p><?php esc_html_e('Customize the login screen and add 2FA authentication for WordPress.', 'secure-login-customizer'); ?></p>
            <?php settings_errors(); ?>
            <form method="post" action="options.php">
                <?php
                settings_fields('secure_login_customizer_options');
                do_settings_sections('secure_login_customizer');
                submit_button();
                ?>
            </form>
        </div>
        <?php
    }

function display_settings_link( $links ) {
			$settings_link = '<a href="options-general.php?page=secure_login_customizer">' . __( 'Settings', 'secure_login_customizer' ) . '</a>';
			array_unshift( $links, $settings_link );
			return $links;
		}

 
function display_dashboard_page() {
			$active_tab = isset( $_GET['tab'] ) ? sanitize_text_field( $_GET['tab'] ) : 'general';
			?>
			<div class="wrap">
				<h1><?php _e( 'Secure Login Customizer', 'secure_login_customizer' ); ?></h1>
				<h2 class="nav-tab-wrapper">
					<a href="?page=secure_login_customizer_dashboard&tab=general" class="nav-tab <?php echo $active_tab == 'general' ? 'nav-tab-active' : ''; ?>"><?php _e( 'General', 'secure_login_customizer' ); ?></a>
					<a href="?page=secure_login_customizer_dashboard&tab=security" class="nav-tab <?php echo $active_tab == 'security' ? 'nav-tab-active' : ''; ?>"><?php _e( 'Security', 'secure_login_customizer' ); ?></a>
					<a href="?page=secure_login_customizer_dashboard&tab=login_customization" class="nav-tab <?php echo $active_tab == 'login_customization' ? 'nav-tab-active' : ''; ?>"><?php _e( 'Login Customization', 'secure_login_customizer' ); ?></a>
					<a href="?page=secure_login_customizer_dashboard&tab=custom_message" class="nav-tab <?php echo $active_tab == 'custom_message' ? 'nav-tab-active' : ''; ?>"><?php _e( 'Custom Message', 'secure_login_customizer' ); ?></a>
					<a href="?page=secure_login_customizer_dashboard&tab=shortcodes" class="nav-tab <?php echo $active_tab == 'shortcodes' ? 'nav-tab-active' : ''; ?>"><?php _e( 'Shortcodes and Miscellaneous', 'secure_login_customizer' ); ?></a>
				</h2>
				<?php
				switch ( $active_tab ) {
					case 'general':
						$this->tab_general();
						break;
					case 'security':
						$this->tab_security();
						break;
					case 'login_customization':
						$this->tab_login_customization();
						break;
					case 'custom_message':
						$this->tab_custom_message();
						break;
					case 'shortcodes':
						$this->tab_shortcode();
						break;
				}
				?>
			</div>
			<?php
		}

function tab_general() {
    $options = get_option('secure_login_customizer_options', secure_login_customizer_get_default_options());

    // Enable 2FA
    $enable_2fa = isset($options['general']['enable_2fa']) ? (bool) $options['general']['enable_2fa'] : true;

    // Enable backup codes
    $enable_backup_codes = isset($options['general']['enable_backup_codes']) ? (bool) $options['general']['enable_backup_codes'] : true;

    // Disable 2FA deactivation
    $disable_2fa_deactivation = isset($options['general']['disable_2fa_deactivation']) ? (bool) $options['general']['disable_2fa_deactivation'] : false;

    // Allowed security groups
    $allowed_groups = isset($options['general']['allowed_groups']) ? (array) $options['general']['allowed_groups'] : array();

    ?>
    <div class="tab_content" id="tab_1">
        <table class="form_table">
            <tr valign="top">
                <th scope="row"><?php _e('Activer l\'authentification 2FA', 'secure_login_customizer'); ?></th>
                <td>
                    <input type="checkbox" name="secure_login_customizer_options[general][enable_2fa]" value="1" <?php checked($enable_2fa); ?>>
                </td>
            </tr>
            <tr valign="top">
                <th scope="row"><?php _e('Activer les codes de secours', 'secure_login_customizer'); ?></th>
                <td>
                    <input type="checkbox" name="secure_login_customizer_options[general][enable_backup_codes]" value="1" <?php checked($enable_backup_codes); ?>>
                </td>
            </tr>
            <tr valign="top">
                <th scope="row"><?php _e('Interdire la désactivation de l\'authentification 2FA', 'secure_login_customizer'); ?></th>
                <td>
                    <input type="checkbox" name="secure_login_customizer_options[general][disable_2fa_deactivation]" value="1" <?php checked($disable_2fa_deactivation); ?>>
                </td>
            </tr>
            <tr valign="top">
                <th scope="row"><?php _e('Groupes de sécurité autorisés', 'secure_login_customizer'); ?></th>
                <td>
                    <select multiple name="secure_login_customizer_options[general][allowed_groups][]">
                        <?php
                        $all_groups = secure_login_customizer_get_security_groups();
                        foreach ($all_groups as $group) {
                            echo '<option value="' . esc_attr($group['slug']) . '"' . (in_array($group['slug'], $allowed_groups) ? ' selected' : '') . '>' . esc_html($group['name']) . '</option>';
                        }
                        ?>
                    </select>
                </td>
            </tr>
        </table>
    </div>
    <?php
}

function tab_security() {
    $options = get_option('secure_login_customizer_options', secure_login_customizer_get_default_options());
    ?>
    <div class="tab_content" id="tab_security">
        <table class="form_table">
            <tr valign="top">
                <th scope="row"><?php _e('Activer Security headers', 'secure_login_customizer'); ?></th>
                <td>
                    <input type="checkbox" name="secure_login_customizer_options[security_headers_enabled]" value="1" <?php checked($options['security_headers_enabled'], true); ?>>
                </td>
            </tr>
            <tr valign="top">
                <th scope="row"><?php _e('Activer l\'anonymisation des messages', 'secure_login_customizer'); ?></th>
                <td>
                    <input type="checkbox" name="secure_login_customizer_options[anonymize_headers_enabled]" value="1" <?php checked($options['anonymize_headers_enabled'], true); ?>>
                </td>
            </tr>
            <tr valign="top">
                <th scope="row"><?php _e('Refuser les connexions depuis un proxy', 'secure_login_customizer'); ?></th>
                <td>
                    <input type="checkbox" name="secure_login_customizer_options[proxy_denied]" value="1" <?php checked($options['proxy_denied'], true); ?>>
                </td>
            </tr>
            <tr valign="top">
                <th scope="row"><?php _e('Interdire les mots de passe à faible sécurité', 'secure_login_customizer'); ?></th>
                <td>
                    <input type="checkbox" name="secure_login_customizer_options[weak_passwords_denied]" value="1" <?php checked($options['weak_passwords_denied'], true); ?>>
                </td>
            </tr>
            <tr valign="top">
                <th scope="row"><?php _e('Blacklist', 'secure_login_customizer'); ?></th>
                <td>
                    <textarea name="secure_login_customizer_options[blacklist]" rows="10"><?php echo esc_textarea($options['blacklist']); ?></textarea>
                </td>
            </tr>
            <tr valign="top">
                <th scope="row"><?php _e('Whitelist', 'secure_login_customizer'); ?></th>
                <td>
                    <textarea name="secure_login_customizer_options[whitelist]" rows="10"><?php echo esc_textarea($options['whitelist']); ?></textarea>
                </td>
            </tr>
            <tr valign="top">
                <th scope="row"><?php _e('Nombre de tentatives de connexions avant désactivation (0 = jamais)', 'secure_login_customizer'); ?></th>
                <td>
                    <input type="number" name="secure_login_customizer_options[login_attempts]" value="<?php echo esc_attr($options['login_attempts']); ?>" min="0" max="20">
                </td>
            </tr>
            <tr valign="top">
                <th scope="row"><?php _e('Temps de blocage du compte (en secondes, 0 = aucun)', 'secure_login_customizer'); ?></th>
                <td>
                    <input type="number" name="secure_login_customizer_options[lockout_duration]" value="<?php echo esc_attr($options['lockout_duration']); ?>" min="0" max="300">
                </td>
            </tr>
        </table>
    </div>
    <?php
}

/**
 * Callback for "Custom Login Screen" tab.
 */
function tab_custom_login_screen()
{
    $options = get_option('secure_login_customizer_options', secure_login_customizer_get_default_options());

    ?>
    <div class="tab_content" id="tab_custom_login_screen">
        <table class="form_table">
            <tr valign="top">
                <th scope="row"><?php _e('URL du logo', 'secure_login_customizer'); ?></th>
                <td>
                    <input type="text" name="secure_login_customizer_logo_url" value="<?php echo esc_attr($options['custom_login_screen']['logo_url']); ?>">
                </td>
            </tr>
            <tr valign="top">
                <th scope="row"><?php _e('URL de l\'image pour le bureau', 'secure_login_customizer'); ?></th>
                <td>
                    <input type="text" name="secure_login_customizer_desktop_image_url" value="<?php echo esc_attr($options['custom_login_screen']['desktop_image_url']); ?>">
                </td>
            </tr>
            <tr valign="top">
                <th scope="row"><?php _e('URL de l\'image pour le mobile', 'secure_login_customizer'); ?></th>
                <td>
                    <input type="text" name="secure_login_customizer_mobile_image_url" value="<?php echo esc_attr($options['custom_login_screen']['mobile_image_url']); ?>">
                </td>
            </tr>
            <tr valign="top">
                <th scope="row"><?php _e('Couleur du bouton de connexion', 'secure_login_customizer'); ?></th>
                <td>
                    <input type="text" name="secure_login_customizer_button_color" value="<?php echo esc_attr($options['custom_login_screen']['button_color']); ?>">
                </td>
            </tr>
            <tr valign="top">
                <th scope="row"><?php _e('Couleur de fond', 'secure_login_customizer'); ?></th>
                <td>
                    <input type="text" name="secure_login_customizer_background_color" value="<?php echo esc_attr($options['custom_login_screen']['background_color']); ?>">
                </td>
            </tr>
            <tr valign="top">
                <th scope="row"><?php _e('Couleur du texte', 'secure_login_customizer'); ?></th>
                <td>
                    <input type="text" name="secure_login_customizer_text_color" value="<?php echo esc_attr($options['custom_login_screen']['text_color']); ?>">
                </td>
            </tr>
            <tr valign="top">
                <th scope="row"><?php _e('Couleur des bordures', 'secure_login_customizer'); ?></th>
                <td>
                    <input type="text" name="secure_login_customizer_border_color" value="<?php echo esc_attr($options['custom_login_screen']['border_color']); ?>">
                </td>
            </tr>
            <tr valign="top">
                <th scope="row"><?php _e('Niveau de transparence (de 0 à 100)', 'secure_login_customizer'); ?></th>
                <td>
                    <input type="number" name="secure_login_customizer_opacity" min="0" max="100" value="<?php echo esc_attr($options['custom_login_screen']['opacity']); ?>">
                </td>
            </tr>
        </table>
    </div>
    <?php
}

function tab_custom_message() {
    $options = get_option('secure_login_customizer_options', secure_login_customizer_get_default_options());
    ?>
    <div class="tab_content" id="tab_custom_message">
        <table class="form_table">
            <tr valign="top">
                <th scope="row"><?php _e('URL de la page d\'information QR-Code', 'secure_login_customizer'); ?></th>
                <td>
                    <input type="text" name="secure_login_customizer_options[custom_message][qr_code_url]" value="<?php echo esc_attr($options['custom_message']['qr_code_url']); ?>">
                </td>
            </tr>
            <tr valign="top">
                <th scope="row"><?php _e('URL de la page d\'information Codes secrets', 'secure_login_customizer'); ?></th>
                <td>
                    <input type="text" name="secure_login_customizer_options[custom_message][secret_code_url]" value="<?php echo esc_attr($options['custom_message']['secret_code_url']); ?>">
                </td>
            </tr>
            <tr valign="top">
                <th scope="row"><?php _e('URL de la page d\'information Désactivation de compte', 'secure_login_customizer'); ?></th>
                <td>
                    <input type="text" name="secure_login_customizer_options[custom_message][deactivation_url]" value="<?php echo esc_attr($options['custom_message']['deactivation_url']); ?>">
                </td>
            </tr>
        </table>
    </div>
    <?php
}

function tab_shortcodes() {
    ?>
    <div class="tab_content" id="tab_shortcodes">
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec quis neque et diam bibendum vestibulum. Fusce rhoncus tincidunt aliquet. Sed elementum lorem ut massa consectetur, vel lobortis massa tincidunt. In ullamcorper iaculis lacinia. Duis in massa ultricies, sodales lectus non, fringilla nibh. Fusce posuere tortor a eros consectetur, at varius urna placerat. Nulla posuere consequat mi, sed posuere velit varius sit amet. Ut facilisis ipsum sed lectus ornare posuere. Nam sit amet lectus justo. Sed rhoncus urna vel diam vulputate, ut tempor justo bibendum. Duis ullamcorper magna vel elementum faucibus.</p>
        <p>In hac habitasse platea dictumst. Sed id commodo justo. Sed at placerat orci. Morbi lobortis vestibulum sagittis. Ut efficitur lacus nec elit consectetur cursus. Vestibulum at leo ut felis tristique gravida. Nulla eget lorem ut magna efficitur dapibus. Nullam vehicula quam ac urna blandit ultrices. Sed ac tristique eros. Ut euismod mi ac augue pulvinar, ut commodo eros consectetur. Donec dignissim felis ac sapien bibendum, id eleifend enim faucibus. Ut non leo ornare, rutrum felis eget, efficitur diam. Proin tincidunt lobortis ipsum, vel viverra nibh. Integer tincidunt pharetra libero, vel suscipit magna aliquam id. Aliquam erat volutpat.</p>
        <p>Nullam euismod sapien vel purus tristique, sed ultricies nisi efficitur. Nulla facilisi. Nam commodo euismod turpis id maximus. Sed venenatis tellus euismod eros finibus, quis rhoncus augue pellentesque. Vivamus commodo imperdiet nulla vel sagittis. Fusce fringilla suscipit mauris, eget interdum risus consectetur ac. Duis consequat mi sit amet elit rhoncus, at tincidunt mi fringilla. Donec ornare nulla vitae ipsum posuere varius. Integer eu congue lorem, id efficitur enim. Etiam euismod semper sapien a rhoncus. Nam volutpat quam non porttitor malesuada. Morbi semper orci vitae velit vulputate, sit amet blandit metus tempor.</p>
    </div>
    <?php
}  

/**
 * Enqueue scripts and styles.
 */
function secure_login_customizer_enqueue_scripts() {
    wp_enqueue_style( 'secure-login-customizer-style', plugin_dir_url( __FILE__ ) . 'css/style.css' );
    wp_enqueue_script( 'secure-login-customizer-script', plugin_dir_url( __FILE__ ) . 'js/script.js', array( 'jquery' ), '', true );
}


function secure_login_customizer_register_settings() {
    register_setting('secure_login_customizer_options', 'secure_login_customizer_options', array($this, 'secure_login_customizer_sanitize_options'));
    add_action( 'admin_enqueue_scripts', array( $this, 'secure_login_customizer_enqueue_scripts' ) );
}

function secure_login_customizer_sanitize_options($options) {
    // Sanitize and validate options here
    return $options;
}

function secure_login_customizer_add_settings_link($links) {
    $settings_link = '<a href="options-general.php?page=secure-login-customizer">' . __('Settings') . '</a>';
    array_push($links, $settings_link);
    return $links;
}

 

