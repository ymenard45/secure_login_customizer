<?php
/*
Plugin Name: Mon Google Authentificator
Plugin URI: https://sitewebprodesign.fr
Description: Un plugin d'authentification à deux facteurs pour WordPress en utilisant Google Authenticator
Version: 1.0
Author: Y.MENARD
Author URI: https://sitewebprodesign.fr
License: GPLv2 or later
Text Domain: mon-google-authentificator
*/

// Protection
if ( ! defined( 'ABSPATH' ) ) {
    exit; // Exit if accessed directly.
}

// Déclarations :
define( 'SLC_PLUGIN_VERSION', '1.0.0' );
define( 'SLC_PLUGIN_DIR', plugin_dir_path( __FILE__ ) );
define( 'SLC_PLUGIN_URL', plugin_dir_url( __FILE__ ) );

// Initialisation :
add_action( 'admin_menu', 'slc_add_admin_menu' );
add_action( 'admin_init', 'slc_settings_init' );

function slc_add_admin_menu() {
    add_options_page(
        'SecureLoginCustomizer Settings',
        'SecureLoginCustomizer',
        'manage_options',
        'secure-login-customizer',
        'slc_options_page'
    );
}

function slc_settings_init() {
    register_setting( 'slc_options_group', 'slc_settings' );

    add_settings_section(
        'slc_settings_section',
        __( 'Secure Login Customizer Settings', 'slc' ),
        'slc_settings_section_callback',
        'slc_options_group'
    );

    // Ajouter les onglets
    add_settings_section(
        'slc_tab1_section',
        __( 'Tab 1', 'slc' ),
        'slc_tab1_section_callback',
        'slc_options_group'
    );
    add_settings_section(
        'slc_tab2_section',
        __( 'Tab 2', 'slc' ),
        'slc_tab2_section_callback',
        'slc_options_group'
    );
    add_settings_section(
        'slc_tab3_section',
        __( 'Tab 3', 'slc' ),
        'slc_tab3_section_callback',
        'slc_options_group'
    );
    add_settings_section(
        'slc_tab4_section',
        __( 'Tab 4', 'slc' ),
        'slc_tab4_section_callback',
        'slc_options_group'
    );
    add_settings_section(
        'slc_tab5_section',
        __( 'Tab 5', 'slc' ),
        'slc_tab5_section_callback',
        'slc_options_group'
    );

    // Ajouter les champs de saisie pour chaque onglet
    slc_tab1_settings_init();
    slc_tab2_settings_init();
    slc_tab3_settings_init();
    slc_tab4_settings_init();
    slc_tab5_settings_init();
}

// Fonction générale pour l'affichage des options et des onglets 
function slc_options_page() {
    ?>
    <div class="wrap">
        <h1><?php echo esc_html( get_admin_page_title() ); ?></h1>
        <form action="options.php" method="post">
            <?php settings_fields( 'slc_options_group' ); ?>
            <?php do_settings_sections( 'slc_options_group' ); ?>
            <?php submit_button( __( 'Save Changes', 'slc' ) ); ?>
        </form>
    </div>
    <?php
}

// Fonctions spécifiques aux onglets:
function slc_tab1_settings_init() {
    // Fonction pour initialiser les champs de l'onglet 1
}

function slc_tab2_settings_init() {
    // Fonction pour initialiser les champs de l'onglet 2
}

function slc_tab3_settings_init() {
    // Fonction pour initialiser les champs de l'onglet 3
}

function slc_tab4_settings_init() {
    // Fonction pour initialiser les champs de l'onglet 4
}

function slc_tab5_settings_init() {
    // Fonction pour initialiser les champs de l'onglet 5
}

// Fonctions pour l'affichage des champs de saisie des onglets

// Onglet 1
function slc_tab1_settings_init() {
    add_settings_field(
        'slc_enable_2fa',
        __( 'Enable 2FA Authentication', 'slc' ),
        'slc_enable_2fa_callback',
        'slc_options_group',
        'slc_tab1_section'
    );

    add_settings_field(
        'slc_enable_backup_code',
        __( 'Enable Backup Code', 'slc' ),
        'slc_enable_backup_code_callback',
        'slc_options_group',
        'slc_tab1_section'
    );

    add_settings_field(
        'slc_restrict_2fa_deactivation',
        __( 'Restrict 2FA Deactivation', 'slc' ),
        'slc_restrict_2fa_deactivation_callback',
        'slc_options_group',
        'slc_tab1_section'
    );

    add_settings_field(
        'slc_2fa_security_groups',
        __( '2FA Security Groups', 'slc' ),
        'slc_2fa_security_groups_callback',
        'slc_options_group',
        'slc_tab1_section'
    );
}

function slc_enable_2fa_callback() {
    // Fonction pour afficher la case à cocher "Enable 2FA Authentication"
}

function slc_enable_backup_code_callback() {
    // Fonction pour afficher la case à cocher "Enable Backup Code"
}

function slc_restrict_2fa_deactivation_callback() {
    // Fonction pour afficher la case à cocher "Restrict 2FA Deactivation"
}

function slc_2fa_security_groups_callback() {
    // Fonction pour afficher la zone de saisie "2FA Security Groups"
}


// Onglet 2
function slc_tab2_settings_init() {
    add_settings_field(
        'slc_enable_security_headers',
        __( 'Enable Security Headers', 'slc' ),
        'slc_enable_security_headers_callback',
        'slc_options_group',
        'slc_tab2_section'
    );

    add_settings_field(
        'slc_anonymize_messages',
        __( 'Anonymize Messages', 'slc' ),
        'slc_anonymize_messages_callback',
        'slc_options_group',
        'slc_tab2_section'
    );

    add_settings_field(
        'slc_reject_proxy_connections',
        __( 'Reject Proxy Connections', 'slc' ),
        'slc_reject_proxy_connections_callback',
        'slc_options_group',
        'slc_tab2_section'
    );

    add_settings_field(
        'slc_reject_weak_passwords',
        __( 'Reject Weak Passwords', 'slc' ),
        'slc_reject_weak_passwords_callback',
        'slc_options_group',
        'slc_tab2_section'
    );

    add_settings_field(
        'slc_blacklist',
        __( 'Blacklist', 'slc' ),
        'slc_blacklist_callback',
        'slc_options_group',
        'slc_tab2_section'
    );

    add_settings_field(
        'slc_whitelist',
        __( 'Whitelist', 'slc' ),
        'slc_whitelist_callback',
        'slc_options_group',
        'slc_tab2_section'
    );

    add_settings_field(
        'slc_max_login_attempts',
        __( 'Max Login Attempts', 'slc' ),
        'slc_max_login_attempts_callback',
        'slc_options_group',
        'slc_tab2_section'
    );

  // Suite de l'onglet 2
	function slc_max_login_attempts_callback() {
	// Fonction pour afficher la zone de saisie "Max Login Attempts"
	}

	function slc_account_lockout_time_callback() {
	// Fonction pour afficher la zone de saisie "Account Lockout Time"
	}

	// Onglet 3
	function slc_tab3_settings_init() {
	add_settings_field(
	'slc_login_logo_url',
	__( 'Login Logo URL', 'slc' ),
	'slc_login_logo_url_callback',
	'slc_options_group',
	'slc_tab3_section'
	);

	 
	add_settings_field(
		'slc_desktop_logo_url',
		__( 'Desktop Logo URL', 'slc' ),
		'slc_desktop_logo_url_callback',
		'slc_options_group',
		'slc_tab3_section'
	);

	add_settings_field(
		'slc_mobile_logo_url',
		__( 'Mobile Logo URL', 'slc' ),
		'slc_mobile_logo_url_callback',
		'slc_options_group',
		'slc_tab3_section'
	);

	add_settings_field(
		'slc_button_color',
		__( 'Button Color', 'slc' ),
		'slc_button_color_callback',
		'slc_options_group',
		'slc_tab3_section'
	);

	add_settings_field(
		'slc_background_color',
		__( 'Background Color', 'slc' ),
		'slc_background_color_callback',
		'slc_options_group',
		'slc_tab3_section'
	);

	add_settings_field(
		'slc_text_color',
		__( 'Text Color', 'slc' ),
		'slc_text_color_callback',
		'slc_options_group',
		'slc_tab3_section'
	);

	add_settings_field(
		'slc_border_color',
		__( 'Border Color', 'slc' ),
		'slc_border_color_callback',
		'slc_options_group',
		'slc_tab3_section'
	);

	add_settings_field(
		'slc_opacity_level',
		__( 'Opacity Level', 'slc' ),
		'slc_opacity_level_callback',
		'slc_options_group',
		'slc_tab3_section'
	);
	}

	function slc_login_logo_url_callback() {
	// Fonction pour afficher la zone de saisie "Login Logo URL"
	}

	function slc_desktop_logo_url_callback() {
	// Fonction pour afficher la zone de saisie "Desktop Logo URL"
	}

	function slc_mobile_logo_url_callback() {
	// Fonction pour afficher la zone de saisie "Mobile Logo URL"
	}

	function slc_button_color_callback() {
	// Fonction pour afficher la zone de saisie "Button Color"
	}

	function slc_background_color_callback() {
	// Fonction pour afficher la zone de saisie "Background Color"
	}

	function slc_text_color_callback() {
	// Fonction pour afficher la zone de saisie "Text Color"
	}

	function slc_border_color_callback() {
	// Fonction pour afficher la zone de saisie "Border Color"
	}

	function slc_opacity_level_callback() {
	// Fonction pour afficher la zone de saisie "Opacity Level"
	}

	// Onglet 4

	function slc_tab4_settings_init() {
	add_settings_field(
	'slc_qr_code_page_url',
	__( 'QR Code Page URL', 'slc' ),
	'slc_qr_code_page_url_callback',
	'slc_options_group',
	'slc_tab4_section'
	);
	}
	
	// Création du menu dans l'interface d'administration
add_submenu_page(
    'options-general.php',
    __( 'SecureLoginCustomizer Settings', 'slc' ),
    __( 'SecureLoginCustomizer', 'slc' ),
    'manage_options',
    'slc_options',
    'slc_options_page'
);

// Ajout des onglets
add_action( 'admin_init', 'slc_tab1_settings_init' );
add_action( 'admin_init', 'slc_tab2_settings_init' );
add_action( 'admin_init', 'slc_tab3_settings_init' );
add_action( 'admin_init', 'slc_tab4_settings_init' );

// Ajout des fonctions pour la création des onglets
add_action( 'slc_options_tabs', 'slc_options_tab1' );
add_action( 'slc_options_tabs', 'slc_options_tab2' );
add_action( 'slc_options_tabs', 'slc_options_tab3' );
add_action( 'slc_options_tabs', 'slc_options_tab4' );
add_action( 'slc_options_tabs', 'slc_options_tab5' );

// Initialisation du plugin
add_action( 'admin_init', 'slc_plugin_init' );

function slc_add_menu() {
    add_submenu_page(
        'plugins.php',
        __( 'SecureLoginCustomizer', 'slc' ),
        __( 'SecureLoginCustomizer', 'slc' ),
        'manage_options',
        'slc_options',
        'slc_options_page'
    );

    add_dashboard_page(
        __( 'SecureLoginCustomizer', 'slc' ),
        __( 'SecureLoginCustomizer', 'slc' ),
        'manage_options',
        'slc_options',
        'slc_options_page'
    );
}

// Ajout du menu
add_action( 'admin_menu', 'slc_add_menu' );

function slc_load_textdomain() {
    load_plugin_textdomain( 'slc', false, dirname( plugin_basename( __FILE__ ) ) . '/languages/' );
}

// Chargement du fichier de traduction
add_action( 'plugins_loaded', 'slc_load_textdomain' );

function slc_activate_plugin() {
    // Création des options du plugin
    $options = array(
        'enable_2fa' => false,
        'enable_backup_code' => false,
        'restrict_2fa_deactivation' => false,
        '2fa_security_groups' => '',
        'enable_security_headers' => false,
        'anonymize_messages' => false,
        'reject_proxy_connections' => false,
        'reject_weak_passwords' => false,
        'blacklist' => '',
        'whitelist' => '',
        'max_login_attempts' => 5,
        'account_lockout_time' => 5,
        'login_logo_url' => '',
        'desktop_logo_url' => '',
        'mobile_logo_url' => '',
        'button_color' => '',
        'background_color' => '',
        'text_color' => '',
        'border_color' => '',
        'opacity_level' => 100,
        'qr_code_page_url' => '',
        'secret_code_page_url' => '',
        'disable_account_page_url' => ''
    );

    // Enregistrement des options du plugin
    add_option( 'slc_options', $options );

    // Création de la table de la liste noire (blacklist) si elle n'existe pas
    global $wpdb;
    $table_name = $wpdb->prefix . 'slc_blacklist';
    $charset_collate = $wpdb->get_charset_collate();

    $sql = "CREATE TABLE IF NOT EXISTS $table_name (
        id mediumint(9) NOT NULL AUTO_INCREMENT,
        ip varchar(39) NOT NULL,
        PRIMARY KEY  (id)
    ) $charset_collate;";

    require_once( ABSPATH . 'wp-admin/includes/upgrade.php' );
    dbDelta( $sql );
}

// Activation du plugin
register_activation_hook( __FILE__, 'slc_activate_plugin' );

