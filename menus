<?php
/**
 * Plugin Name: Secure Login Customizer
 * Plugin URI: https://example.com/secure-login-customizer
 * Description: Un plugin pour customiser l'écran de connexion et ajouter des options de sécurité.
 * Version: 1.0
 * Author: Your Name
 * Author URI: https://example.com
 * Text Domain: secure-login-customizer
 * Domain Path: /languages
 * License: GPL v2 or later
 * License URI: https://www.gnu.org/licenses/gpl-2.0.html
 */

// Ligne 1
function slc_plugin_action_links($links) {
    $settings_link = '<a href="options-general.php?page=secure-login-customizer">' . __('Settings', 'secure-login-customizer') . '</a>';
    array_unshift($links, $settings_link);
    return $links;
}
// Ligne 5
add_filter('plugin_action_links_' . plugin_basename(__FILE__), 'slc_plugin_action_links');

// Charge le fichier de traduction du plugin.
function slc_load_plugin_textdomain() {
    load_plugin_textdomain('secure-login-customizer', false, basename(dirname(__FILE__)) . '/languages');
}
// Ligne 10
add_action('plugins_loaded', 'slc_load_plugin_textdomain');

// Ligne 1
function slc_add_plugin_menu() {
    add_options_page(
        __('Secure Login Customizer', 'secure-login-customizer'),
        __('Secure Login Customizer', 'secure-login-customizer'),
        'manage_options',
        'secure-login-customizer',
        'slc_render_plugin_settings_page'
    );
}
// Ligne 7
add_action('admin_menu', 'slc_add_plugin_menu');

// strcuture html pour les onglets
function slc_render_plugin_settings_page() {
    ?>
		<div class="wrap">
		<div class="slc-title-container">
        <span class="dashicons dashicons-shield"></span>
        <h1><?php _e('Secure Login Customizer', 'secure-login-customizer'); ?></h1>
		<span class="dashicons dashicons-shield"></span>
		</div>
				<style>
					.tab-content p:first-child  {
					margin-top: 15px; /* Ajustez cette valeur en fonction de l'espace souhaité */
					}
					.dashicons-shield {
					font-size: 36px; /* Ajustez la taille de l'icône */
					margin-right: 10px; /* Ajoutez une marge à droite pour l'espacement entre l'icône et le texte */
					vertical-align: middle; /* Alignement vertical avec le texte */
					}
					
					.form{
					margin-top:15 px;	
					}
					.wrap > h1 {
					color:blue;	
					margin-bottom: 30px;
				    }

					.tab-content {
					margin-left: 25px;
					}
				
					h1.slc-plugin-title,
					.tab-content h2 {
					display: none;
					}
					
					.slc-title-container {
						text-align: center;
					}

					.slc-title-container h1 {
						display: inline-block;
						vertical-align: middle;
						margin-left: 15px;
						margin-right: 10px;
						font-size:36px;
						color:blue;
					}
					
					.nav-tab {padding-top:10px;
							   padding-bottom:10px;
							   margin-top:20px;
							   margin-bottom:20px}

					.dashicons-shield {
						font-size: 36px;
						margin-right: 5px;
						vertical-align: middle;
					}
										
										
			 </style>

        
        <h2 class="nav-tab-wrapper">
            <a href="#tab-1" class="nav-tab"><?php _e('2FA', 'secure-login-customizer'); ?></a>
            <a href="#tab-2" class="nav-tab"><?php _e('Sécurité', 'secure-login-customizer'); ?></a>
            <a href="#tab-3" class="nav-tab"><?php _e('Customisation login screen', 'secure-login-customizer'); ?></a>
            <a href="#tab-4" class="nav-tab"><?php _e('Customisation message', 'secure-login-customizer'); ?></a>
            <a href="#tab-5" class="nav-tab"><?php _e('Lorem Ipsum', 'secure-login-customizer'); ?></a>
        </h2>
    </div>
    <?php
	
    // gestion de chaque onglets
 
    // Contenu de l'onglet 1
    ?>
    <div id="tab-1" class="tab-content">
        <h2><?php _e('2FA', 'secure-login-customizer'); ?></h2>
        <form method="post" action="options.php">
            <?php
			
			settings_fields('slc_2fa_settings');
			do_settings_sections('slc_2fa_settings');
			submit_button();

			
            // Nous ajouterons des champs de formulaire et des sections ici plus tard.
            ?>
        </form>
    </div>
    <?php

    // Contenu de l'onglet 2
    ?>
    <div id="tab-2" class="tab-content">
        <h2><?php _e('Sécurité', 'secure-login-customizer'); ?></h2>
        <form method="post" action="options.php">
              
			<?php
			  // champs de formulaire onglet 2
				settings_fields('slc_security_settings');
				do_settings_sections('slc_security_settings');
				submit_button();

			?>
        </form>
    </div>
    <?php

    // Contenu de l'onglet 3
    ?>
    <div id="tab-3" class="tab-content">
        <h2><?php _e('Customisation login screen', 'secure-login-customizer'); ?></h2>
        <form method="post" action="options.php">
            <?php
            //  champs de formulaire onglet 3
			
			settings_fields('slc_custom_login_screen_settings');
			do_settings_sections('slc_custom_login_screen_settings');
			submit_button();

			
			
			
            ?>
        </form>
    </div>
    <?php

    // Contenu de l'onglet 4
    ?>
    <div id="tab-4" class="tab-content">
        <h2><?php _e('Customisation message', 'secure-login-customizer'); ?></h2>
        <form method="post" action="options.php">
            <?php
            // champs de formulaire onglet 4
			settings_fields('slc_custom_message_settings');
			do_settings_sections('slc_custom_message_settings');
			submit_button();

			
			
            ?>
        </form>
    </div>
    <?php

    // Contenu de l'onglet 5
    ?>
    <div id="tab-5" class="tab-content">
        <h2><?php _e('Lorem Ipsum', 'secure-login-customizer'); ?></h2>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cras euismod orci ut ullamcorper tincidunt. Sed auctor sapien ut facilisis fermentum.</p>
        <p>In hac habitasse platea dictumst. Vestibulum pellentesque elit et erat congue, id ultricies metus vestibulum. Duis commodo augue ac magna laoreet ultrices.</p>
    </div>
    <?php
	
	
}   // fin function slc_render_plugin_settings_page

// gestion des onglets avec javascript
function slc_admin_scripts() {
    ?>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function(event) {
                    event.preventDefault();
                    const target = event.target.getAttribute('href');
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('nav-tab-active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
                    event.target.classList.add('nav-tab-active');
                    document.querySelector(target).style.display = 'block';
                });
            });
            tabs[0].click();
        });
    </script>
    <?php
}
// activation onglets
add_action('admin_footer', 'slc_admin_scripts');

//  fonction pour enregistrer les paramètres de l'onglet 1
function slc_register_2fa_settings() {
    register_setting('slc_2fa_settings', 'slc_2fa_settings', 'slc_sanitize_2fa_settings');

    add_settings_section('slc_2fa_section', __('Paramètres 2FA', 'secure-login-customizer'), 'slc_2fa_section_callback', 'slc_2fa_settings');

    // Ajoutez les champs de l'onglet 1 ici (nous le ferons dans les prochaines étapes).
}

// Enregistre les groupes de sécurité sélectionnés
register_setting('slc_2fa', 'slc_security_group', array(
    'type' => 'array',
    'sanitize_callback' => 'slc_sanitize_security_group',
));

add_action('admin_init', 'slc_register_2fa_settings');

// focntion pour les champs de l'onglet 1
function slc_2fa_section_callback() {
    _e('Paramètres de l\'authentification à deux facteurs (2FA).', 'secure-login-customizer');
}

// Ligne 1
function slc_add_2fa_fields() {
    add_settings_field('enable_2fa', __('Activer 2FA authentification', 'secure-login-customizer'), 'slc_enable_2fa_callback', 'slc_2fa_settings', 'slc_2fa_section');
    add_settings_field('enable_backup_codes', __('Activer code de secours', 'secure-login-customizer'), 'slc_enable_backup_codes_callback', 'slc_2fa_settings', 'slc_2fa_section');
    add_settings_field('disable_2fa_disabling', __('Interdire la désactivation de 2FA authentification', 'secure-login-customizer'), 'slc_disable_2fa_disabling_callback', 'slc_2fa_settings', 'slc_2fa_section');
	add_settings_field(
		'slc_security_group', // field ID
		'Activer l\'authentification à deux facteurs (2FA) pour les groupes d\'utilisateurs suivants :', // field title 
		'slc_security_group_callback', // callback function
		'slc_2fa_settings', // settings page slug
		'slc_2fa_section' // section ID
	);
	
}
// Ligne 5
add_action('admin_init', 'slc_add_2fa_fields');

// focntion pour gerer activer option activer 2FA de l'onglet 1
// focntion pour gerer activer option activer 2FA de l'onglet 1
function slc_enable_2fa_callback() {
    $options = get_option('slc_2fa_settings');
    $checked = isset($options['enable_2fa']) ? $options['enable_2fa'] : false;
    ?>
    <input type="checkbox" name="slc_2fa_settings[enable_2fa]" value="1" <?php checked(1, $checked, true); ?>>
    <?php
}

// focntion pour gerer l'option 'code de securité'
function slc_enable_backup_codes_callback() {
    $options = get_option('slc_2fa_settings');
    $checked = isset($options['enable_backup_codes']) ? $options['enable_backup_codes'] : false;
    ?>
    <input type="checkbox" name="slc_2fa_settings[enable_backup_codes]" value="1" <?php checked(1, $checked, true); ?>>
    <?php
}

// focntion pour gerer desactiver option activer 2FA de l'onglet 1
function slc_disable_2fa_disabling_callback() {
    $options = get_option('slc_2fa_settings');
    ?>
    <input type="checkbox" name="slc_2fa_settings[disable_2fa_disabling]" value="1" <?php checked(1, $options['disable_2fa_disabling'], true); ?>>
    <?php
}

// fonction activation 2FA pour les roles 
function slc_enable_2fa_for_groups_callback() {
    $options = get_option('slc_options');
    $user_roles = slc_list_user_roles(); 
    $all_roles = $wp_roles->roles;

    foreach ($all_roles as $role_key => $role) {
        $checked = isset($options['enable_2fa_for_groups'][$role_key]) ? 'checked' : '';
        echo '<input type="checkbox" name="slc_options[enable_2fa_for_groups][' . $role_key . ']" value="1" ' . $checked . '> ' . $role['name'] . '<br>';
    }
}

// selection des roles
function slc_list_user_roles() {
    global $wp_roles;
    if (!isset($wp_roles)) {
        $wp_roles = new WP_Roles();
    }
    return $wp_roles->get_names();
}


function slc_sanitize_security_group($input) {
    $valid_roles = array_keys(get_editable_roles());

    if (is_array($input)) {
        foreach ($input as $role) {
            if (!in_array($role, $valid_roles)) {
                return array();
            }
        }
    } else {
        return array();
    }

    return $input;
}


function slc_security_group_callback() {
     $slc_options = get_option('slc_2fa_settings');
    
    if (!is_array($slc_options)) {
        $slc_options = array();
    }

    $roles = array(
        'administrator' => __('Administrateur', 'secure-login-customizer'),
        'editor' => __('Éditeur', 'secure-login-customizer'),
        'author' => __('Auteur', 'secure-login-customizer'),
        'contributor' => __('Contributeur', 'secure-login-customizer'),
        'subscriber' => __('Abonné', 'secure-login-customizer'),
    );

    // Ajoutez les groupes de sécurité supplémentaires pour WooCommerce ici, si nécessaire
    // $roles['woocommerce_role'] = __('WooCommerce Role', 'secure-login-customizer');

    foreach ($roles as $role => $role_name) {
        $checked = isset($slc_options['slc_security_group'][$role]) ? 'checked' : '';
        echo "<input type='checkbox' name='slc_2fa_settings[slc_security_group][{$role}]' {$checked}>{$role_name}<br>";
    }
}

/* Fonctions pour gérer l'onglet 2 */

// fonction pour enregistrer les paramètres de onglet 2
 
	function slc_register_security_settings() {
		register_setting('slc_security_settings', 'slc_security_settings', 'slc_sanitize_security_settings');

		add_settings_section('slc_security_section', __('Paramètres de sécurité', 'secure-login-customizer'), 'slc_security_section_callback', 'slc_security_settings');

		// Ajoutez les champs de l'onglet 2 ici (nous le ferons dans les prochaines étapes).
	}
 
	add_action('admin_init', 'slc_register_security_settings');

	function slc_security_section_callback() {
		_e('Paramètres de sécurité pour le site.', 'secure-login-customizer');
	}

	// Ligne 1
	function slc_add_security_fields() {
		add_settings_field('enable_security_headers', __('Activer Security headers', 'secure-login-customizer'), 'slc_enable_security_headers_callback', 'slc_security_settings', 'slc_security_section');
		// Ajoutez les autres champs de l'onglet 2 ici (nous le ferons dans les prochaines étapes).
	}
	 
	add_action('admin_init', 'slc_add_security_fields');

	// champ security headers
	function slc_enable_security_headers_callback() {
		$options = get_option('slc_security_settings');
		?>
		<input type="checkbox" name="slc_security_settings[enable_security_headers]" value="1" <?php checked(1, $options['enable_security_headers'], true); ?>>
		<?php
	}
/* Fonctions pour gérer l'onglet 3 */
 
 // Ligne 1
 
	function slc_register_custom_login_screen_settings() {
		register_setting('slc_custom_login_screen_settings', 'slc_custom_login_screen_settings', 'slc_sanitize_custom_login_screen_settings');

		add_settings_section('slc_custom_login_screen_section', __('Paramètres de customisation de l’écran de connexion', 'secure-login-customizer'), 'slc_custom_login_screen_section_callback', 'slc_custom_login_screen_settings');

		// Ajoutez les champs de l'onglet 3 ici (nous le ferons dans les prochaines étapes).
	}    // fin slc_register_custom_login_screen_settings
		add_action('admin_init', 'slc_register_custom_login_screen_settings');

	function slc_custom_login_screen_section_callback() {
		_e('Paramètres de customisation de l’écran de connexion.', 'secure-login-customizer');
	}
 
	function slc_add_custom_login_screen_fields() {
		add_settings_field('logo_url', __('URL du logo', 'secure-login-customizer'), 'slc_logo_url_callback', 'slc_custom_login_screen_settings', 'slc_custom_login_screen_section');
		// Ajoutez les autres champs de l'onglet 3 ici (nous le ferons dans les prochaines étapes).
	}
	// Ligne 4
	add_action('admin_init', 'slc_add_custom_login_screen_fields');

// Ligne 1
	function slc_logo_url_callback() {
    $options = get_option('slc_custom_login_screen_settings');
    ?>
    <input type="text" name="slc_custom_login_screen_settings[logo_url]" value="<?php echo esc_attr($options['logo_url']); ?>" size="75">
    <?php
}

/* Fonctions pour gérer l'onglet 4 */

	function slc_register_custom_message_settings() {
    register_setting('slc_custom_message_settings', 'slc_custom_message_settings', 'slc_sanitize_custom_message_settings');

    add_settings_section('slc_custom_message_section', __('Paramètres de customisation des messages', 'secure-login-customizer'), 'slc_custom_message_section_callback', 'slc_custom_message_settings');

    // Ajoutez les champs de l'onglet 4 ici (nous le ferons dans les prochaines étapes).
	}
	add_action('admin_init', 'slc_register_custom_message_settings');

	function slc_custom_message_section_callback() {
    _e('Paramètres de customisation des messages.', 'secure-login-customizer');
	}

	function slc_add_custom_message_fields() {
    add_settings_field('qr_code_info_url', __('URL de la page pour information QR-CODE', 'secure-login-customizer'), 'slc_qr_code_info_url_callback', 'slc_custom_message_settings', 'slc_custom_message_section');
    // Ajoutez les autres champs de l'onglet 4 ici (nous le ferons dans les prochaines étapes).
	}
	add_action('admin_init', 'slc_add_custom_message_fields');

function slc_qr_code_info_url_callback() {
    $options = get_option('slc_custom_message_settings');
    ?>
    <input type="text" name="slc_custom_message_settings[qr_code_info_url]" value="<?php echo esc_attr($options['qr_code_info_url']); ?>" size="75">
    <?php
}

 


/* Fonctions pour gérer l'onglet 5 non necessaires */

/* Fonctions pour créer le menu */



// Créer le menu de l'extension
function slc_add_plugin_page() {
    add_menu_page(
        'Secure Login Customizer',
        'Secure Login Customizer',
        'manage_options',
        'secure-login-customizer',
        'slc_render_plugin_settings_page',
        'dashicons-lock',
        100
    );
}
add_action('admin_menu', 'slc_add_plugin_page');

